"use strict";var __importDefault=void 0&&(void 0).__importDefault||function(mod){return mod&&mod.__esModule?mod:{"default":mod}};Object.defineProperty(exports,"__esModule",{value:true});const module_alias_1=require("module-alias");(0,module_alias_1.addAliases)({"__dirname":__dirname,"${__dirname}/interfaces":`${__dirname}/interface`,"${__dirname}/config":`${__dirname}/config`,"${__dirname}/middlewares":`${__dirname}/middlewares`});console.log("__dirname",__dirname);const koa_1=__importDefault(require("koa"));const awilix_1=require("awilix");const co_1=__importDefault(require("co"));const koa_swig_1=__importDefault(require("koa-swig"));const index_1=__importDefault(require("${__dirname}/config/index"));const koa_static_1=__importDefault(require("koa-static"));const awilix_koa_1=require("awilix-koa");//koa中没有实现的路由重定向到index.html
const koa2_connect_history_api_fallback_1=require("koa2-connect-history-api-fallback");const app=new koa_1.default;const{port,viewDir,memoryFlag,staticDir}=index_1.default;//静态资源生效节点
app.use((0,koa_static_1.default)(staticDir));const container=(0,awilix_1.createContainer)();//所有的可以被注入的代码都在container中
container.loadModules([`${__dirname}/services/*.js`],{formatName:"camelCase",resolverOptions:{lifetime:awilix_1.Lifetime.SCOPED}});//每一次用户请求router中 都会从容器中取到注入的服务
app.use((0,awilix_koa_1.scopePerRequest)(container));app.context.render=co_1.default.wrap((0,koa_swig_1.default)({root:viewDir,autoescape:true,cache:memoryFlag,writeBody:false,ext:"html"}));app.use((0,awilix_koa_1.loadControllers)(`${__dirname}/controllers/*.js`));app.use((0,koa2_connect_history_api_fallback_1.historyApiFallback)({index:"/",whiteList:["/api","/dev"]}));// 让所有的路由全部生效
app.listen(port,()=>{console.log(`Chalee BFF App启动成功 http://localhost:${port}/`)});